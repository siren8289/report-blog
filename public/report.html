<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>주간 리포트 작성</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        max-width: 720px;
        margin: 40px auto;
        padding: 0 16px;
      }
      label {
        font-weight: 600;
        display: block;
        margin-top: 14px;
      }
      input,
      textarea,
      .chips {
        width: 100%;
        box-sizing: border-box;
      }
      input,
      textarea {
        padding: 10px;
        margin: 6px 0 10px;
      }
      textarea {
        height: 320px;
        line-height: 1.6;
      }
      .hint {
        color: #666;
        font-size: 12px;
        margin: 10px 0;
      }
      .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin: 8px 0 12px;
      }
      .chip {
        border: 1px solid #bbb;
        padding: 6px 10px;
        border-radius: 999px;
        cursor: pointer;
        user-select: none;
      }
      .chip.active {
        background: #111;
        color: #fff;
        border-color: #111;
      }
      button {
        padding: 10px 16px;
        cursor: pointer;
      }
      .row {
        /* display: flex; */
        gap: 30px;
      }
      .row > * {
        flex: 1;
      }
    </style>
  </head>
  <body>
    <h1>주간 리포트 작성</h1>

    <form id="reportForm">
      <div class="row">
        <div>
          <label>이름</label>
          <input name="name" required placeholder="이름을 입력해주세요.." />
        </div>

        <div>
          <label>파트 <span class="hint">(여러 개 선택 가능)</span></label>
          <div id="devChips" class="chips" aria-label="개발자 파트">
            <div class="chip" data-value="FE">FE</div>
            <div class="chip" data-value="BE">BE</div>
            <div class="chip" data-value="PM">PM</div>
            <div class="chip" data-value="Design">Design</div>
          </div>
          <input type="hidden" name="studentId" id="devHidden" required />
        </div>

        <div>
          <label>제출일</label>
          <input type="date" name="submittedAt" id="submittedAt" required />
          <div class="hint">기본값은 오늘 날짜예요.</div>
        </div>
      </div>

      <label>리포트 내용</label>
      <div class="hint">
        ✅ 붙여넣기(Ctrl/Cmd+V)와 드래그&드롭 사용 가능. 자유롭게 복붙하세요.
      </div>
      <textarea id="reportText" name="report" required></textarea>

      <button id="submitBtn" type="submit">제출</button>
    </form>

    <script>
      // 제출일 기본값: 오늘
      const submittedAtInput = document.getElementById("submittedAt");
      (function setToday() {
        const t = new Date();
        const yyyy = t.getFullYear();
        const mm = String(t.getMonth() + 1).padStart(2, "0");
        const dd = String(t.getDate()).padStart(2, "0");
        submittedAtInput.value = `${yyyy}-${mm}-${dd}`;
      })();

      // multi_select → 숨김필드에 "FE, BE" 저장
      const chips = document.querySelectorAll("#devChips .chip");
      const devHidden = document.getElementById("devHidden");
      const syncHidden = () => {
        const values = [...chips]
          .filter((c) => c.classList.contains("active"))
          .map((c) => c.dataset.value);
        devHidden.value = values.join(", ");
      };
      chips.forEach((c) =>
        c.addEventListener("click", () => {
          c.classList.toggle("active");
          syncHidden();
        })
      );

      // 제출
      document
        .getElementById("reportForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          if (!devHidden.value.trim()) {
            alert("개발자 파트를 하나 이상 선택하세요.");
            return;
          }
          if (!submittedAtInput.value) {
            alert("제출일을 선택하세요.");
            return;
          }

          // YYYY-MM-DD → ISO(자정 기준)
          const submittedAtISO = new Date(
            submittedAtInput.value + "T00:00:00"
          ).toISOString();

          const payload = {
            name: e.target.name.value.trim(),
            studentId: devHidden.value.trim(),
            report: e.target.report.value.trim(),
            submittedAt: submittedAtISO, // ← 추가된 날짜 필드
          };

          const API = "https://report-blog.vercel.app/api/submit";
          const btn = document.getElementById("submitBtn");
          btn.disabled = true;
          btn.textContent = "제출 중…";
          try {
            const res = await fetch(API, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
            if (res.ok) {
              alert("제출 완료!");
              e.target.reset();
              chips.forEach((c) => c.classList.remove("active"));
              syncHidden();
              setToday(); // 날짜도 오늘로 복구
            } else {
              alert("제출 실패: " + (await res.text()));
            }
          } catch (err) {
            alert("네트워크 오류: " + (err?.message || err));
          } finally {
            btn.disabled = false;
            btn.textContent = "제출";
          }
        });
    </script>
  </body>
</html>
